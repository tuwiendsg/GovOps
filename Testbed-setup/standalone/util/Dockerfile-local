# This script is generated by ./SensorGatewayUtil.sh to run the custom gateway.
# The configuration of the gateway are
# GWBASEIMAGE: dockerfile/java:latest
# GovOps: yes

FROM java:latest
MAINTAINER iCOMOT

# GovOps required services
# Add httpd (apache 2.2.29)
RUN apt-get update
RUN apt-get -y install apache2

ADD ./mapper.sh /usr/lib/cgi-bin/mapper
RUN chmod a+x /usr/lib/cgi-bin/mapper
  
#Add some test capabilities
COPY capabilities/ /usr/lib/cgi-bin/capabilities/
RUN chmod a+x -R /usr/lib/cgi-bin/capabilities/
RUN chmod 4777 /usr/lib/cgi-bin/capabilities/killJava.sh
RUN touch /usr/lib/cgi-bin/capabilities/log
RUN chmod a+rw /usr/lib/cgi-bin/capabilities/log

# Add deployment agent 
RUN mkdir /usr/share/provi-agent/
RUN chmod a+x /usr/share/provi-agent/
ADD ./agent.sh /usr/share/provi-agent/agent.sh
ADD ./profile.sh /usr/share/provi-agent/profile.sh
ADD ./starter_ubuntu.sh /usr/share/provi-agent/starter.sh
#ADD ./decommission /bin/decommission

# Add the sensor stuff
#TODO configure broker ip
RUN echo "mqtt_broker=192.168.200.128" >> /etc/environment 
RUN mkdir /usr/share/sensor
ADD s-distribution/* /usr/share/sensor/


# Open ports 80 (REST server) 2812 (Monit) 5683 (CoAP Server)
EXPOSE 80 2812 5683

# add metadata and GovOps IP
RUN echo "GOVOPS_ENDPOINT=192.168.1.3:8080" >> /etc/environment
RUN echo "GATEWAY_META=\"location=home&owner=stefan\"" >> /etc/environment

# Start cron deamon and hold on to a process
RUN chmod +x /usr/share/provi-agent/starter.sh
CMD ["/bin/sh", "/usr/share/provi-agent/starter.sh"]

